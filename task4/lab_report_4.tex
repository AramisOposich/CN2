%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% CN2 Labreport template
%
% License:
% CC BY-NC-SA 3.0 (http://creativecommons.org/licenses/by-nc-sa/3.0/)
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\documentclass[parskip=full]{scrartcl}

\usepackage[binary-units=true]{siunitx}  % Provides the \SI{}{} command for typesetting SI units
%\sisetup{per-mode=symbol,per-symbol = p}

\usepackage{graphicx} % Required for the inclusion of images
\usepackage{booktabs} % nicer tables
\usepackage[noabbrev]{cleveref} % automatic references
\usepackage{listings} % typeset code
\usepackage[backend=biber]{biblatex}
\addbibresource{referenzen.bib}

\crefname{lstlisting}{listing}{listings} % for referencing code
\Crefname{lstlisting}{Listing}{Listings} % for referencing code

\usepackage[headsepline]{scrlayer-scrpage} % header
\ohead{Group 06} % right part of header
\ihead{Assignment 4} % left part of header

\lstset{basicstyle=\ttfamily} % monospaced font in listing

% Automata 
\usepackage{pgfplots}
\usetikzlibrary{automata,arrows,positioning} 

%----------------------------------------------------------------------------------------
%	DOCUMENT INFORMATION
%----------------------------------------------------------------------------------------

\begin{document}
\begin{titlepage}
    \centering
    \vspace*{2cm}
    {\Huge \textbf{Communication Networks 2}}\\
    SS 2021\\
    \vspace*{1cm}
    {\Large Assignment 4}
    \\\vspace*{3cm}
    {\Large \textbf{Group 06}}\\
    \vspace*{1cm}
    {\large 
        \begin{tabular}{l c c}
            Name & Mat.Nummer \\ \hline
            Paul Kloker & 12034928 \\
            Juan Aramis Oposich & 11701238
        \end{tabular}
    }
    \\\vspace*{7cm}
    \today
\end{titlepage}

%----------------------------------------------------------------------------------------
%	SECTION 1
%----------------------------------------------------------------------------------------
\section{Task description and setup} \label{sec:task}
The task of the last assignment is to model a network in NS-3, which is an open source network simulator, according to the following network diagram (\cref{fig:2a}).
Furthermore, a 10 seconds long simulation with a ping measurement from node 1 to node 3 shall be done and the generated measurement data discussed.
\begin{figure}[!h]
	\centering
	\begin{tikzpicture}[ >=stealth', auto, semithick, node distance=6cm]
	\tikzstyle{every state}=[fill=white,draw=black,thick,text=black,scale=1]
	\node[state]    (0)               {$1$};
	\node[state]    (1)[right of=0]   {$2$};
	\node[state]    (2)[ right of=1]  {$3$};
	\path
	(0)	edge[above left] 	    	node{$10.0.120.2\ \ \ \ $}		(1)
	(0)	edge[above right] 	    	node{$\ \ \ \ 10.0.120.1$}		(1)
	(0)	edge[below] 	    		node{$PointToPoint$}				(1)
	(1)	edge[above left] 	    	node{$10.0.248.1\ \ \ \ $}		(2)
	(1)	edge[above right] 	    	node{$\ \ \ \ 10.0.248.2$}		(2)
	(1)	edge[below] 	    		node{$CSMA$}				(2);
	
	\end{tikzpicture}
	\caption{Network topology}
	\label{fig:2a}
\end{figure}

For this the latest version of NS-3 was downloaded form \verb|https://www.nsmam.org| and build with the command \verb|$ ./bulid.py|. 


%----------------------------------------------------------------------------------------
%	SECTION 2
%----------------------------------------------------------------------------------------
\section{NS-3 Model} \label{sec:procedure}
NS-3 models are C++ based and consist out of network nodes, network devices, communication channels and applications.
Most of the code is based on the second tutorial in the example folder.
Listing \ref{lst:creation} shows the creation of the topology
Because our system consists out of one PointToPoint connection and one Carrier Sense Multiple Access (CSMA) network, different kind of nodes were created and the given channel attributes were set by using the helper objects.
To finish the topology creation helper objects were used to install the network devices and a IP stack for every node.

\begin{lstlisting}[language=c++, frame=single, captionpos=b, caption={Topology creation}, label=lst:creation]
//P2P
NodeContainer p2pNodes;
p2pNodes.Create (2);

PointToPointHelper pointToPoint;
pointToPoint.SetDeviceAttribute ("DataRate", 
                                  StringValue ("11Mbps"));
pointToPoint.SetChannelAttribute ("Delay", 
                                   StringValue ("80ms"));
                                   
NetDeviceContainer p2pDevices;
p2pDevices = pointToPoint.Install (p2pNodes);

//CSMA
NodeContainer csmaNodes;
csmaNodes.Add (p2pNodes.Get (0));
csmaNodes.Create (1);

CsmaHelper csma;
csma.SetChannelAttribute ("DataRate", 
                           StringValue ("70Mbps"));
csma.SetChannelAttribute ("Delay", 
                           TimeValue (MicroSeconds (1000)));
                           
NetDeviceContainer csmaDevices;
csmaDevices = csma.Install (csmaNodes);

InternetStackHelper stack;the
stack.Install (p2pNodes.Get (1));
stack.Install (csmaNodes);
\end{lstlisting}


\begin{table}[hb]
	\centering
	\begin{tabular}{lll}
		\toprule
		\textbf{Node No.} & \textbf{NS-3 Node Container Element} & \textbf{IP Address}\\ \midrule
		1 & p2pNodes.Get(1) & 10.0.120.2 \\
		2 & p2pNodes.Get(0) & 10.0.120.1 \\
		2 & csmaNodes.Get(0) & 10.0.248.1 \\
		3 & csmaNodes.Get(1) & 10.0.248.2 \\
		\bottomrule
	\end{tabular}
	\caption{Nodes and the according NS-3 node container element}
	\label{tab:Nodes}
\end{table}
\clearpage

To create a routing table with the \verb|Ipv4GlobalRoutingHelper|, both subnets first got the right address space assigned to them (see \ref{lst:address}).

\begin{lstlisting}[language=c++, frame=single, captionpos=b, caption={IP address assignment and routing table creation}, label=lst:address]
Ipv4AddressHelper address;
address.SetBase ("10.0.120.0", "255.255.255.0");
Ipv4InterfaceContainer p2pInterfaces;
p2pInterfaces = address.Assign (p2pDevices);

address.SetBase ("10.0.248.0", "255.255.255.0");
Ipv4InterfaceContainer csmaInterfaces;
csmaInterfaces = address.Assign (csmaDevices);

Ipv4GlobalRoutingHelper::PopulateRoutingTables ();
\end{lstlisting}

Listing \ref{lst:ping} shows how the ping to the third node was created and installed on the first node. 
The attribute \verb|Verbose| was set to true to create a ping-style output. 
The payload was set to 1024 bytes and the interval between the ping messages to 0.2 Seconds.
The last two lines of \cref{lst:ping} define how long the ping application will run during the simulation

\begin{lstlisting}[language=c++, frame=single , captionpos=b, label=lst:ping]
V4PingHelper ping = V4PingHelper (
csmaInterfaces.GetAddress (1));
ping.SetAttribute ("Verbose", BooleanValue (true));
ping.SetAttribute ("Size", UintegerValue(1024));
ping.SetAttribute ("Interval", TimeValue(Seconds(0.2)));
ApplicationContainer apps = ping.Install (p2pNodes.Get (1));
apps.Start (Seconds (1.0));
apps.Stop (Seconds (10.0));
}
\end{lstlisting}

Before the simulation was invoked the stop time was specified and packet capturing was enabled for all P2P and CSMA nodes (see \cref{lst:simulation}).

\begin{lstlisting}[language=c++, frame=single , captionpos=b, caption={pcap and simulation start}, label=lst:simulation]
csma.EnablePcapAll("assignment4", true);
pointToPoint.EnablePcapAll ("assignment4", true);

Simulator::Stop (Seconds (10.0));
Simulator::Run ();
Simulator::Destroy ();
}
\end{lstlisting}

The code was then compiled and execute with \verb|waf|. This created the ping measurement and pcap data which will be discussed in the next section. 

\section{Data analysis} \label{sec:data}

% 

%Questions to be answered:
%1.) Why do the reported round-trip-times deviate from the sum of link delays? 
% 	 ->
%2.) Why does the first ping reply have a higher round-trip-time than subsequent ones?
%    -> because of ARP
%3.) Which types of delay have been defined and used in Assignment 4? 
% 	 -> Propagation delay, Transmission delay
%4.) How can we compute the transmission delay?
%    -> t_T = n/b  (n = number of bits, b = bandwidth in bits/sec)
%5.) You simulated ping requests using a network consisting of one Point-to-Point link and one CSMA link. Which types of delay can the observed round-trip-delay be decomposed to?
%    -> 162ms propagation delay, 1.774 ms transmission delay ()and 5us processing) 
%6.) What do we need ARP for?
%    -> to get the MAC address of a node in the same network. (only IP address is known) . No ARP in P2P because there is just one possible Receiver
%8.) Why is checksum computation turned off by default in a ns-3 simulation? Is it a problem/does it make a difference to omit checksums? !! The checksum is disabled by default to let the simulations run faster./ There is no need for a checksum because there are no Errors !!
The simulation delivered 45 ping measurements of which 44 had a Round Trip Time (RTT) of exact 163.779 ms. 
Only the first message deviated from this value with a RRT of 178.881 ms. 
This is because of the two initial ARP request and response messages which can be seen in the pcap files of node two and three.
The Address Resolution Protocol (ARP) is used in IPv4 networks to obtain the MAC address of a node. 
This is done by broadcasting a ARP request containing the IP address of the node. 
If a node has this address, it answers with an ARP response containing its MAC address.
In the beginning of the Simulation both nodes in the csma network need to obtain the MAC address of the other node to forward the ping message.
This leads to a higher RTT in the first ping measurement because after the initial setup the MAC address is saved in the ARP table.
In the P2P network ARP is not used because there is just one single communication partner and no need to obtain the MAC address.

After the initial set-up the RTT can be divided into the propagation delay ($ t_p $) of the link which is the time a packet needs to travel between nodes and the transmission delay ($ t_t $) which is the time it takes to transmit a packet from the host to the transmission medium.  It can be calculated with the number of bits to be sent ($n_{bit}$) and the bandwidth of the link ($b$): $ t_t = n_{bit}/b$
\[t_p = 2\cdot(80 \si{\milli\second}+1 \si{\milli\second}) = 162 \si{\milli\second} \]
\[t_t = 2\cdot(\frac{1054\cdot8}{\SI{11}{\mega\bit\per\second}} +\frac{1054\cdot8}{\SI{70}{\mega\bit\per\second}}) = 1.774\si{\milli\second} \]
\[ RTT = t_p + t_t = 163.774 \]

There are ohter delay types as well, like processing delay and queuing delay, but they are not considered in the simulation. 
In reality the RTT is a bit different each time because of the changing network load, and there are sometimes lost packets,  but this behavior was not considered in this model.



%----------------------------------------------------------------------------------------
%	SECTION 3
%----------------------------------------------------------------------------------------

\section{Conclusion}
NS-3 is a powerful tool to easily model different kind of networks. This is useful to test different set-ups or new protocols, but it has limits.
Only the modeled behavior is simulated not more. 
So simulation does not replace the use of the brain.


%----------------------------------------------------------------------------------------
%	SECTION X
%---------------------------------------------------------------------------------------

\printbibliography

\end{document}
